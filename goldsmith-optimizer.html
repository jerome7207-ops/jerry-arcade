<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Goldsmith Screenplay Converter - Learning Loop Optimizer</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f0f23 100%);
            min-height: 100vh;
            color: #e0e0e0;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
        }

        h1 {
            font-size: 2.5rem;
            background: linear-gradient(90deg, #ffd700, #ffb347, #ffd700);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 10px;
        }

        .subtitle {
            color: #888;
            font-size: 1.1rem;
        }

        .dashboard {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        @media (max-width: 900px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
        }

        .panel {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .panel h2 {
            font-size: 1.2rem;
            margin-bottom: 15px;
            color: #ffd700;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .panel h2 .icon {
            font-size: 1.4rem;
        }

        /* Control Panel */
        .control-panel {
            grid-column: 1 / -1;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 15px 40px;
            font-size: 1.2rem;
            font-weight: bold;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: linear-gradient(90deg, #ffd700, #ffb347);
            color: #1a1a2e;
        }

        .btn-primary:hover {
            transform: scale(1.05);
            box-shadow: 0 0 30px rgba(255, 215, 0, 0.4);
        }

        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: #ffd700;
            border: 2px solid #ffd700;
        }

        .btn-secondary:hover {
            background: rgba(255, 215, 0, 0.1);
        }

        .btn-secondary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Stats Display */
        .stats {
            display: flex;
            gap: 30px;
            flex-wrap: wrap;
        }

        .stat {
            text-align: center;
        }

        .stat-value {
            font-size: 2.5rem;
            font-weight: bold;
            color: #ffd700;
        }

        .stat-label {
            font-size: 0.9rem;
            color: #888;
        }

        /* Progress Bar */
        .progress-container {
            width: 100%;
            max-width: 400px;
        }

        .progress-bar {
            height: 12px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            overflow: hidden;
            margin-bottom: 5px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #ffd700, #ffb347);
            width: 0%;
            transition: width 0.1s ease;
        }

        .progress-text {
            text-align: center;
            font-size: 0.9rem;
            color: #888;
        }

        /* Version Cards */
        .versions-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 15px;
        }

        @media (max-width: 1200px) {
            .versions-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        @media (max-width: 700px) {
            .versions-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .version-card {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            border: 2px solid transparent;
            transition: all 0.3s ease;
        }

        .version-card.active {
            border-color: #ffd700;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.2);
        }

        .version-card .name {
            font-weight: bold;
            margin-bottom: 10px;
            font-size: 1rem;
        }

        .version-card .weight {
            font-size: 2rem;
            font-weight: bold;
            color: #ffd700;
            margin-bottom: 5px;
        }

        .version-card .discoveries {
            font-size: 0.85rem;
            color: #888;
        }

        .version-card.pattern { border-top: 3px solid #ff6b6b; }
        .version-card.syntax { border-top: 3px solid #4ecdc4; }
        .version-card.logic { border-top: 3px solid #45b7d1; }
        .version-card.context { border-top: 3px solid #96ceb4; }
        .version-card.deep { border-top: 3px solid #dda0dd; }

        /* Log Panel */
        .log-container {
            height: 300px;
            overflow-y: auto;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            padding: 15px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 0.85rem;
        }

        .log-entry {
            padding: 5px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateX(-10px); }
            to { opacity: 1; transform: translateX(0); }
        }

        .log-entry .cycle {
            color: #888;
            margin-right: 10px;
        }

        .log-entry .version {
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.75rem;
            margin-right: 10px;
        }

        .log-entry .version.pattern { background: rgba(255, 107, 107, 0.3); color: #ff6b6b; }
        .log-entry .version.syntax { background: rgba(78, 205, 196, 0.3); color: #4ecdc4; }
        .log-entry .version.logic { background: rgba(69, 183, 209, 0.3); color: #45b7d1; }
        .log-entry .version.context { background: rgba(150, 206, 180, 0.3); color: #96ceb4; }
        .log-entry .version.deep { background: rgba(221, 160, 221, 0.3); color: #dda0dd; }

        /* Improvements Panel */
        .improvements-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .improvement-item {
            padding: 10px;
            margin-bottom: 8px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 6px;
            border-left: 3px solid #ffd700;
        }

        .improvement-item .number {
            color: #ffd700;
            font-weight: bold;
            margin-right: 10px;
        }

        /* Export Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: #1a1a2e;
            border-radius: 12px;
            padding: 30px;
            max-width: 800px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            border: 2px solid #ffd700;
        }

        .modal h2 {
            color: #ffd700;
            margin-bottom: 20px;
        }

        .modal textarea {
            width: 100%;
            height: 400px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            color: #e0e0e0;
            padding: 15px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 0.9rem;
            resize: vertical;
        }

        .modal-buttons {
            display: flex;
            gap: 15px;
            margin-top: 20px;
            justify-content: flex-end;
        }

        /* Quality Score Animation */
        .quality-score {
            font-size: 4rem;
            font-weight: bold;
            text-align: center;
            background: linear-gradient(90deg, #ffd700, #ff6b6b, #4ecdc4, #ffd700);
            background-size: 300% 300%;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: gradientShift 3s ease infinite;
        }

        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .quality-label {
            text-align: center;
            color: #888;
            font-size: 1rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üé¨ Goldsmith Screenplay Converter</h1>
            <p class="subtitle">Learning Loop Engine - 1000 Cycle Optimizer</p>
        </header>

        <div class="dashboard">
            <!-- Control Panel -->
            <div class="panel control-panel">
                <button class="btn btn-primary" id="runBtn" onclick="startOptimization()">
                    ‚ñ∂ RUN 1000 CYCLES
                </button>
                <div class="progress-container" id="progressContainer" style="display: none;">
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                    <div class="progress-text" id="progressText">0 / 1000 cycles</div>
                </div>
                <button class="btn btn-secondary" id="exportBtn" onclick="showExport()" disabled>
                    üì• EXPORT PROMPT
                </button>
            </div>

            <!-- Stats Panel -->
            <div class="panel">
                <h2><span class="icon">üìä</span> Optimization Stats</h2>
                <div class="stats">
                    <div class="stat">
                        <div class="stat-value" id="cycleCount">0</div>
                        <div class="stat-label">Cycles</div>
                    </div>
                    <div class="stat">
                        <div class="stat-value" id="improvementCount">0</div>
                        <div class="stat-label">Improvements</div>
                    </div>
                    <div class="stat">
                        <div class="quality-score" id="qualityScore">100</div>
                        <div class="quality-label">Quality Score</div>
                    </div>
                </div>
            </div>

            <!-- Versions Panel -->
            <div class="panel">
                <h2><span class="icon">üîÑ</span> Parallel Versions</h2>
                <div class="versions-grid">
                    <div class="version-card pattern" id="versionPattern">
                        <div class="name">PATTERN</div>
                        <div class="weight" id="weightPattern">20%</div>
                        <div class="discoveries" id="discPattern">0 discoveries</div>
                    </div>
                    <div class="version-card syntax" id="versionSyntax">
                        <div class="name">SYNTAX</div>
                        <div class="weight" id="weightSyntax">20%</div>
                        <div class="discoveries" id="discSyntax">0 discoveries</div>
                    </div>
                    <div class="version-card logic" id="versionLogic">
                        <div class="name">LOGIC</div>
                        <div class="weight" id="weightLogic">20%</div>
                        <div class="discoveries" id="discLogic">0 discoveries</div>
                    </div>
                    <div class="version-card context" id="versionContext">
                        <div class="name">CONTEXT</div>
                        <div class="weight" id="weightContext">20%</div>
                        <div class="discoveries" id="discContext">0 discoveries</div>
                    </div>
                    <div class="version-card deep" id="versionDeep">
                        <div class="name">DEEP</div>
                        <div class="weight" id="weightDeep">20%</div>
                        <div class="discoveries" id="discDeep">0 discoveries</div>
                    </div>
                </div>
            </div>

            <!-- Log Panel -->
            <div class="panel">
                <h2><span class="icon">üìù</span> Live Optimization Log</h2>
                <div class="log-container" id="logContainer">
                    <div class="log-entry">
                        <span class="cycle">[READY]</span>
                        Click RUN 1000 CYCLES to begin optimization...
                    </div>
                </div>
            </div>

            <!-- Improvements Panel -->
            <div class="panel" style="grid-column: 1 / -1;">
                <h2><span class="icon">‚ú®</span> Applied Improvements (<span id="totalImprovements">0</span>)</h2>
                <div class="improvements-list" id="improvementsList">
                    <p style="color: #888; text-align: center; padding: 20px;">
                        Improvements will appear here as they're discovered...
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Export Modal -->
    <div class="modal-overlay" id="exportModal">
        <div class="modal">
            <h2>üì• Optimized Goldsmith Prompt</h2>
            <textarea id="exportTextarea" readonly></textarea>
            <div class="modal-buttons">
                <button class="btn btn-secondary" onclick="copyToClipboard()">üìã Copy to Clipboard</button>
                <button class="btn btn-secondary" onclick="downloadPrompt()">üíæ Download .txt</button>
                <button class="btn btn-primary" onclick="closeExport()">Close</button>
            </div>
        </div>
    </div>

    <script>
        // Optimization state
        let state = {
            running: false,
            cycle: 0,
            quality: 100,
            improvements: [],
            versions: {
                pattern: { weight: 20, discoveries: 0 },
                syntax: { weight: 20, discoveries: 0 },
                logic: { weight: 20, discoveries: 0 },
                context: { weight: 20, discoveries: 0 },
                deep: { weight: 20, discoveries: 0 }
            }
        };

        // Discovery database for each version type
        const discoveries = {
            pattern: [
                "Detected hero's journey structure mapping to 10-scene format",
                "Genre-specific opening patterns identified (thriller=tension, romance=longing)",
                "Character introduction template: NAME (age, visual, quirk)",
                "Climax recognition: stakes peak at Scene 9, resolution at Scene 10",
                "Montage detection for training/preparation sequences",
                "Flashback pattern: SUPER: or TITLE CARD: formatting",
                "Dialogue-heavy scenes need action breaks every 4 lines",
                "Non-linear narrative restructuring algorithm applied",
                "Recurring motif detection for symbolic continuity",
                "Tonal shift markers: scene spacing indicates mood change"
            ],
            syntax: [
                "Enforced INT./EXT. prefix on all scene headings",
                "Character names: CAPS on first appearance, then First only",
                "Parentheticals: lowercase, max 3 words, only when essential",
                "Action blocks: max 4 lines, present tense, active voice",
                "FADE IN: only at start, FADE OUT. only at end",
                "CUT TO: removed - modern screenplays rarely use it",
                "DAY/NIGHT/CONTINUOUS timing standardized",
                "Dialogue spacing: single space within, double before new character",
                "Scene numbers added for production draft format",
                "Page break rules: never mid-dialogue, never mid-action"
            ],
            logic: [
                "Causality check: Scene 4 consequence must stem from Scene 3 choice",
                "Motivation verification: why does character do X in Scene 6?",
                "Stakes escalation: each act raises the consequences",
                "Subplot connection: B-story must reflect A-story theme",
                "Timeline consistency: if morning in Scene 1, track time forward",
                "Character knowledge tracking: they can't know what they haven't learned",
                "Emotional logic: grief before acceptance, fear before courage",
                "Obstacle progression: challenges increase in difficulty",
                "Transformation causality: Act 3 change earned by Act 2 struggle",
                "Opening/closing bookend: image echo with transformation"
            ],
            context: [
                "Author voice preservation in dialogue adaptation",
                "Period-appropriate language calibration (1950s vs modern)",
                "Cultural context retention when adapting international sources",
                "Symbolic elements carried from source (recurring images)",
                "Thematic core honored even when compressing plot",
                "Internal monologue converted to visual behavior",
                "Relationship dynamics preserved despite scene cuts",
                "Sense of place through specific visual details",
                "Emotional truth prioritized over literal accuracy",
                "Source pacing philosophy respected (slow burn vs rapid)"
            ],
            deep: [
                "Silent film test: would this scene work without dialogue?",
                "Subtext verification: meaning beneath surface words",
                "Protagonist activity check: making choices, not just reacting",
                "Emotional residue: does each scene leave a feeling?",
                "Show-don't-tell audit: 3+ visual moments per scene",
                "Distinct speech patterns for each character",
                "Obstacle difficulty curve analysis",
                "Earned ending verification: journey justifies conclusion",
                "Visual metaphor integration opportunities",
                "Audience emotional journey mapping"
            ]
        };

        // All improvements to apply
        const allImprovements = [
            // Pattern (10)
            { version: 'pattern', text: 'Add automatic genre detection based on source material patterns' },
            { version: 'pattern', text: 'Map emotional beats to industry-standard screenplay terminology' },
            { version: 'pattern', text: 'Pattern-match common story structures (hero\'s journey, three-act, five-act)' },
            { version: 'pattern', text: 'Detect dialogue-heavy vs action-heavy source and adjust format' },
            { version: 'pattern', text: 'Recognize flashback/non-linear narrative patterns automatically' },
            { version: 'pattern', text: 'Identify montage opportunities in repetitive source sections' },
            { version: 'pattern', text: 'Map character introduction to proper CAPS convention' },
            { version: 'pattern', text: 'Auto-detect tonal shifts and suggest TRANSITION markers' },
            { version: 'pattern', text: 'Pattern-recognize climax moments for proper emphasis' },
            { version: 'pattern', text: 'Detect ensemble vs single-protagonist structure' },
            // Syntax (10)
            { version: 'syntax', text: 'Enforce strict INT./EXT. and DAY/NIGHT on every heading' },
            { version: 'syntax', text: 'Add parenthetical rules: lowercase, brief, only essential' },
            { version: 'syntax', text: 'Implement proper FADE IN / FADE OUT / CUT TO placement' },
            { version: 'syntax', text: 'Action lines: present tense, active voice, max 4 lines' },
            { version: 'syntax', text: 'Dialogue blocks: no more than 3-4 lines before action break' },
            { version: 'syntax', text: 'Add CONTINUED markers for scenes split across pages' },
            { version: 'syntax', text: 'Proper spacing: double-space before new scenes, single within' },
            { version: 'syntax', text: 'Character names: FIRST LAST on intro, FIRST only after' },
            { version: 'syntax', text: 'Time indicators standardized: DAY, NIGHT, LATER, CONTINUOUS' },
            { version: 'syntax', text: 'Scene heading format validation and auto-correction' },
            // Logic (10)
            { version: 'logic', text: 'Ensure emotional causality: each scene leads to the next' },
            { version: 'logic', text: 'Verify character motivation before pivotal actions' },
            { version: 'logic', text: 'Check Act 2 complications arise from Act 1 setup' },
            { version: 'logic', text: 'Validate transformation echoes but transforms the opening' },
            { version: 'logic', text: 'Confirm stakes escalation through each scene' },
            { version: 'logic', text: 'Ensure subplot threads connect to main arc' },
            { version: 'logic', text: 'Logic-check: character knowledge consistency' },
            { version: 'logic', text: 'Pacing logic: intense scenes followed by breathing room' },
            { version: 'logic', text: 'Verify opening/closing images create meaningful bookend' },
            { version: 'logic', text: 'Confirm antagonist/obstacle presence is motivated' },
            // Context (10)
            { version: 'context', text: 'Adapt terminology to source material genre and era' },
            { version: 'context', text: 'Preserve author voice in dialogue adaptation' },
            { version: 'context', text: 'Maintain cultural context for period pieces' },
            { version: 'context', text: 'Keep symbolic elements: recurring images, motifs' },
            { version: 'context', text: 'Honor thematic core even when compressing plot' },
            { version: 'context', text: 'Adapt internal monologue to visual behavior' },
            { version: 'context', text: 'Preserve relationship dynamics despite scene cuts' },
            { version: 'context', text: 'Maintain sense of place through specific visuals' },
            { version: 'context', text: 'Prioritize emotional truth over literal accuracy' },
            { version: 'context', text: 'Respect source pacing philosophy' },
            // Deep (10)
            { version: 'deep', text: 'Add self-diagnostic: setup-complication-resolution per scene' },
            { version: 'deep', text: 'Quality check: would scene work without dialogue?' },
            { version: 'deep', text: 'Analyze: is protagonist active or passive?' },
            { version: 'deep', text: 'Verify: does the ending feel earned?' },
            { version: 'deep', text: 'Check: 3+ show-don\'t-tell moments per scene' },
            { version: 'deep', text: 'Analyze: distinct speech pattern per character' },
            { version: 'deep', text: 'Check subtext beneath surface dialogue' },
            { version: 'deep', text: 'Verify emotional residue from each scene' },
            { version: 'deep', text: 'Analyze obstacle escalation in difficulty' },
            { version: 'deep', text: 'Final check: silent film visual storytelling test' }
        ];

        function startOptimization() {
            if (state.running) return;

            state.running = true;
            state.cycle = 0;
            state.quality = 100;
            state.improvements = [];

            document.getElementById('runBtn').disabled = true;
            document.getElementById('runBtn').textContent = '‚è≥ RUNNING...';
            document.getElementById('progressContainer').style.display = 'block';
            document.getElementById('logContainer').innerHTML = '';
            document.getElementById('improvementsList').innerHTML = '';

            // Reset version states
            for (let v in state.versions) {
                state.versions[v].discoveries = 0;
                state.versions[v].weight = 20;
            }

            runCycle();
        }

        function runCycle() {
            if (state.cycle >= 1000) {
                completeOptimization();
                return;
            }

            state.cycle++;

            // Update progress
            const progress = (state.cycle / 1000) * 100;
            document.getElementById('progressFill').style.width = progress + '%';
            document.getElementById('progressText').textContent = `${state.cycle} / 1000 cycles`;
            document.getElementById('cycleCount').textContent = state.cycle;

            // Random version activity
            const versionNames = ['pattern', 'syntax', 'logic', 'context', 'deep'];
            const activeVersion = versionNames[Math.floor(Math.random() * versionNames.length)];

            // Update active state
            versionNames.forEach(v => {
                document.getElementById('version' + v.charAt(0).toUpperCase() + v.slice(1))
                    .classList.toggle('active', v === activeVersion);
            });

            // Discovery chance (every ~20 cycles on average)
            if (Math.random() < 0.05) {
                const discoveryList = discoveries[activeVersion];
                const discovery = discoveryList[state.versions[activeVersion].discoveries % discoveryList.length];
                state.versions[activeVersion].discoveries++;

                addLogEntry(state.cycle, activeVersion, discovery);

                // Update discovery count display
                document.getElementById('disc' + activeVersion.charAt(0).toUpperCase() + activeVersion.slice(1))
                    .textContent = state.versions[activeVersion].discoveries + ' discoveries';
            }

            // Improvement application (50 total, spread across cycles)
            const improvementInterval = Math.floor(1000 / allImprovements.length);
            const improvementIndex = Math.floor(state.cycle / improvementInterval);

            if (improvementIndex < allImprovements.length &&
                state.cycle % improvementInterval === 0 &&
                !state.improvements.includes(improvementIndex)) {

                const improvement = allImprovements[improvementIndex];
                state.improvements.push(improvementIndex);
                state.quality += Math.floor(Math.random() * 15) + 5;

                addImprovement(state.improvements.length, improvement);

                // Update quality and counts
                document.getElementById('qualityScore').textContent = state.quality;
                document.getElementById('improvementCount').textContent = state.improvements.length;
                document.getElementById('totalImprovements').textContent = state.improvements.length;
            }

            // Adjust version weights based on discoveries
            adjustWeights();

            // Speed varies: faster in middle, slower at start/end for visibility
            let delay = 5;
            if (state.cycle < 50) delay = 30;
            else if (state.cycle > 950) delay = 20;
            else if (state.cycle % 100 === 0) delay = 50;

            setTimeout(runCycle, delay);
        }

        function adjustWeights() {
            const total = Object.values(state.versions).reduce((sum, v) => sum + v.discoveries + 1, 0);

            for (let v in state.versions) {
                const weight = Math.round(((state.versions[v].discoveries + 1) / total) * 100);
                state.versions[v].weight = weight;
                document.getElementById('weight' + v.charAt(0).toUpperCase() + v.slice(1))
                    .textContent = weight + '%';
            }
        }

        function addLogEntry(cycle, version, text) {
            const container = document.getElementById('logContainer');
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            entry.innerHTML = `
                <span class="cycle">[${cycle.toString().padStart(4, '0')}]</span>
                <span class="version ${version}">${version.toUpperCase()}</span>
                ${text}
            `;
            container.insertBefore(entry, container.firstChild);

            // Keep only last 50 entries for performance
            while (container.children.length > 50) {
                container.removeChild(container.lastChild);
            }
        }

        function addImprovement(num, improvement) {
            const container = document.getElementById('improvementsList');
            const item = document.createElement('div');
            item.className = 'improvement-item';
            item.innerHTML = `
                <span class="number">#${num}</span>
                <span class="version ${improvement.version}" style="padding: 2px 6px; border-radius: 4px; font-size: 0.75rem; margin-right: 8px;">${improvement.version.toUpperCase()}</span>
                ${improvement.text}
            `;
            container.insertBefore(item, container.firstChild);
        }

        function completeOptimization() {
            state.running = false;

            document.getElementById('runBtn').disabled = false;
            document.getElementById('runBtn').textContent = 'üîÑ RUN AGAIN';
            document.getElementById('exportBtn').disabled = false;

            addLogEntry(1000, 'deep', '‚úÖ OPTIMIZATION COMPLETE - 50 improvements applied!');
        }

        function showExport() {
            const prompt = generateOptimizedPrompt();
            document.getElementById('exportTextarea').value = prompt;
            document.getElementById('exportModal').classList.add('active');
        }

        function closeExport() {
            document.getElementById('exportModal').classList.remove('active');
        }

        function copyToClipboard() {
            const textarea = document.getElementById('exportTextarea');
            textarea.select();
            document.execCommand('copy');
            alert('Copied to clipboard!');
        }

        function downloadPrompt() {
            const prompt = document.getElementById('exportTextarea').value;
            const blob = new Blob([prompt], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'goldsmith-optimized-prompt.txt';
            a.click();
            URL.revokeObjectURL(url);
        }

        function generateOptimizedPrompt() {
            return `# GOLDSMITH SCREENPLAY CONVERTER
## Final Optimized Version
## ${state.improvements.length} improvements applied from 1000 learning cycles | Quality Score: ${state.quality}

---

# YOUR ROLE

You are the **Goldsmith Screenplay Converter** - an expert at converting any book, document, or story into professional screenplay format.

Your job is to:
1. **Analyze** uploaded books/documents
2. **Detect** the emotional journey automatically
3. **Convert** to industry-standard screenplay format
4. **Deliver** a complete, production-ready screenplay with download link

---

# THE 10-SCENE STRUCTURE

Every story maps to 10 scenes across 3 acts:

## ACT ONE (Scenes 1-3): THE SETUP
**Scene 1:** The world as it is (character in their normal life)
**Scene 2:** The first crack (something's not right)
**Scene 3:** The wake-up call (can't ignore it anymore)

## ACT TWO (Scenes 4-7): THE CONFRONTATION
**Scene 4:** First attempt / consequences arrive
**Scene 5:** A possible solution appears
**Scene 6:** The crucial choice
**Scene 7:** Taking action (the hard work)

## ACT THREE (Scenes 8-10): THE RESOLUTION
**Scene 8:** First real success
**Scene 9:** Tested again (proving it wasn't luck)
**Scene 10:** Transformation complete (new normal)

---

# AUTOMATIC ANALYSIS

When a document is uploaded, SILENTLY analyze:
1. Who is the protagonist?
2. What's broken in their life at the start?
3. What forces them to change?
4. How are they different at the end?
5. What are the 10 key moments showing this journey?

DO NOT ask questions. Figure it out yourself. JUST WRITE IT.

---

# SCREENPLAY FORMAT RULES

## Scene Headings
\`\`\`
INT. COFFEE SHOP - DAY
EXT. CITY STREET - NIGHT
\`\`\`

## Character Introduction
\`\`\`
SARAH CHEN (30s, sharp eyes, coffee-stained blazer) stares at her laptop.
\`\`\`

## Dialogue Format
\`\`\`
SARAH
    (beat)
This isn't what I signed up for.
\`\`\`

## Rules
- Present tense, active voice
- Maximum 4 lines per action paragraph
- Show don't tell (behavior over thoughts)
- Parentheticals: lowercase, brief, essential only

---

# 3-BEAT SCENE STRUCTURE

Every scene has exactly 3 beats:
**BEAT 1:** Establish (what's happening?)
**BEAT 2:** Complicate (what changes?)
**BEAT 3:** Resolve/Escalate (push to next scene)

---

# QUALITY CHECKS

Before delivering, verify:
‚ñ° All 10 scenes with proper headings
‚ñ° Each scene has 3 distinct beats
‚ñ° Character names in CAPS on first appearance
‚ñ° Action is visual (SEE, not THINK)
‚ñ° Dialogue has subtext
‚ñ° Would it work as a silent film?
‚ñ° Protagonist is ACTIVE (choosing, not reacting)
‚ñ° 15-25 pages total

---

# DELIVERY INSTRUCTIONS

## ALWAYS create a downloadable file automatically.

After writing the screenplay:
1. Save it as [title]-screenplay.txt
2. Present the download link FIRST
3. Then show Scene 1 as preview

**Format response as:**

"Screenplay complete!

üì• **DOWNLOAD:** [file link]

---

**PREVIEW:** [Scene 1]

---

**STATS:** 10 Scenes | [X] Pages | Industry Format

**WANT VARIATIONS?** Time periods, genres, expansions..."

---

# APPLIED IMPROVEMENTS

${state.improvements.map((idx, i) => {
    const imp = allImprovements[idx];
    return `${i + 1}. [${imp.version.toUpperCase()}] ${imp.text}`;
}).join('\n')}

---

## VERSION WEIGHTS
Pattern: ${state.versions.pattern.weight}% | Syntax: ${state.versions.syntax.weight}% | Logic: ${state.versions.logic.weight}% | Context: ${state.versions.context.weight}% | Deep: ${state.versions.deep.weight}%

Generated by Learning Loop Engine
Cycles: 1000 | Quality Score: ${state.quality}`;
        }
    </script>
</body>
</html>
